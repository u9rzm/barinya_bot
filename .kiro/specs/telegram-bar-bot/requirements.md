# Requirements Document

## Introduction

Система Telegram бота для бара, включающая рассылку рекламных акций, мини-приложение с меню, программу лояльности и реферальную систему. Пользователи получают уведомления о промо-акциях через бота, могут просматривать меню бара в мини-приложении, накапливать баллы лояльности и приглашать друзей для получения процента от их заказов.

## Glossary

- **Telegram Bot**: Основной бот, который взаимодействует с пользователями через Telegram
- **Mini App**: Веб-приложение, встроенное в Telegram, отображающее меню бара
- **User**: Пользователь Telegram, взаимодействующий с ботом
- **Bar**: Заведение, для которого создается система
- **Loyalty Points**: Баллы лояльности, накапливаемые пользователями
- **Loyalty Level**: Уровень лояльности пользователя, определяемый общей суммой потраченных денег
- **Referral System**: Реферальная система для привлечения новых пользователей
- **Referrer**: Пользователь, который пригласил другого пользователя
- **Referee**: Пользователь, который был приглашен по реферальной ссылке
- **Promotion**: Рекламная акция бара
- **Menu Item**: Позиция в меню бара
- **Order**: Заказ пользователя
- **Google Sheets**: Таблица Google, используемая для управления меню бара
- **Menu Sync**: Процесс синхронизации меню из Google Sheets в базу данных

## Requirements

### Requirement 1

**User Story:** Как пользователь, я хочу получать уведомления о рекламных акциях бара, чтобы быть в курсе специальных предложений.

#### Acceptance Criteria

1. WHEN администратор создает новую акцию, THEN Telegram Bot SHALL отправить уведомление всем активным пользователям
2. WHEN пользователь впервые запускает бота командой /start, THEN Telegram Bot SHALL зарегистрировать пользователя и отправить приветственное сообщение
3. WHEN пользователь получает уведомление об акции, THEN Telegram Bot SHALL включить в сообщение описание акции, период действия и кнопку для перехода в Mini App
4. WHEN пользователь блокирует бота, THEN Telegram Bot SHALL пометить пользователя как неактивного и прекратить отправку уведомлений

### Requirement 2

**User Story:** Как пользователь, я хочу просматривать меню бара в удобном интерфейсе, чтобы выбрать блюда и напитки.

#### Acceptance Criteria

1. WHEN пользователь открывает Mini App, THEN Mini App SHALL отобразить полное меню бара с категориями
2. WHEN пользователь выбирает категорию, THEN Mini App SHALL показать все позиции этой категории с названиями, описаниями и ценами
3. WHEN меню содержит изображения позиций, THEN Mini App SHALL отобразить изображения вместе с описанием
4. WHEN пользователь просматривает позицию меню, THEN Mini App SHALL показать название, описание, цену и доступность позиции

### Requirement 3

**User Story:** Как пользователь, я хочу накапливать баллы лояльности за заказы и повышать свой уровень, чтобы получать больше преимуществ.

#### Acceptance Criteria

1. WHEN пользователь совершает заказ, THEN Telegram Bot SHALL начислить Loyalty Points на счет пользователя пропорционально сумме заказа
2. WHEN пользователь совершает заказ, THEN Telegram Bot SHALL увеличить общую сумму потраченных денег пользователя на сумму заказа
3. WHEN общая сумма потраченных денег достигает порога следующего уровня, THEN Telegram Bot SHALL повысить Loyalty Level пользователя и отправить уведомление о повышении
4. WHEN пользователь открывает Mini App, THEN Mini App SHALL отобразить текущий баланс Loyalty Points, текущий Loyalty Level и прогресс до следующего уровня
5. WHEN пользователь запрашивает историю баллов, THEN Mini App SHALL показать все транзакции начисления и списания баллов с датами и суммами
6. WHEN баланс Loyalty Points изменяется, THEN Telegram Bot SHALL сохранить новое значение в базе данных немедленно
7. WHEN пользователь достигает нового Loyalty Level, THEN Telegram Bot SHALL применить новый процент начисления баллов для последующих заказов

### Requirement 4

**User Story:** Как администратор бара, я хочу настроить уровни лояльности с разными преимуществами, чтобы мотивировать пользователей тратить больше.

#### Acceptance Criteria

1. WHEN система инициализируется, THEN Telegram Bot SHALL создать минимум три уровня лояльности с разными порогами потраченных денег
2. WHEN администратор настраивает уровень лояльности, THEN Telegram Bot SHALL сохранить название уровня, порог суммы и процент начисления баллов
3. WHEN пользователь просматривает информацию об уровнях, THEN Mini App SHALL показать все доступные уровни с их порогами и преимуществами
4. WHEN система определяет уровень пользователя, THEN Telegram Bot SHALL выбрать наивысший уровень, порог которого не превышает общую сумму потраченных пользователем денег
5. WHEN администратор назначает уровень пользователю по имени, THEN Telegram Bot SHALL установить указанный Loyalty Level этому пользователю независимо от суммы потраченных денег
6. WHEN администратор вручную назначает уровень пользователю, THEN Telegram Bot SHALL отправить уведомление пользователю о назначении нового уровня

### Requirement 5

**User Story:** Как пользователь, я хочу приглашать друзей и получать процент от их заказов, чтобы зарабатывать дополнительные баллы.

#### Acceptance Criteria

1. WHEN пользователь запрашивает реферальную ссылку, THEN Telegram Bot SHALL сгенерировать уникальную реферальную ссылку для этого пользователя
2. WHEN новый пользователь регистрируется по реферальной ссылке, THEN Telegram Bot SHALL связать нового пользователя (Referee) с пригласившим (Referrer)
3. WHEN Referee совершает заказ, THEN Telegram Bot SHALL начислить Referrer 1 процент от суммы заказа в виде Loyalty Points
4. WHEN Referee совершает заказ, THEN Telegram Bot SHALL отправить уведомление Referrer с информацией о начислении баллов и сумме заказа реферала
5. WHEN Referrer просматривает статистику рефералов, THEN Mini App SHALL показать количество приглашенных пользователей и общую сумму заработанных баллов
6. WHEN реферальная связь установлена, THEN Telegram Bot SHALL сохранить связь между Referrer и Referee постоянно

### Requirement 6

**User Story:** Как администратор бара, я хочу управлять меню через Google Sheets и синхронизировать его с ботом, чтобы легко обновлять информацию для пользователей.

#### Acceptance Criteria

1. WHEN администратор редактирует меню в Google Sheets, THEN Google Sheets SHALL содержать колонки: название, описание, цена, категория, URL изображения, доступность
2. WHEN администратор выполняет команду /admin_sync_menu, THEN Telegram Bot SHALL загрузить данные из Google Sheets через Google Sheets API
3. WHEN система загружает меню из Google Sheets, THEN Telegram Bot SHALL обновить все Menu Items в базе данных, добавив новые и обновив существующие
4. WHEN в Google Sheets позиция помечена как недоступная, THEN Telegram Bot SHALL установить is_available=False для этой позиции в базе данных
5. WHEN синхронизация меню завершается, THEN Telegram Bot SHALL отправить администратору сообщение с результатом синхронизации (количество добавленных, обновленных позиций)
6. WHEN происходит ошибка при чтении Google Sheets, THEN Telegram Bot SHALL записать ошибку в лог и отправить администратору сообщение об ошибке

### Requirement 10

**User Story:** Как администратор бара, я хочу управлять акциями через бота, чтобы информировать пользователей о специальных предложениях.

#### Acceptance Criteria

1. WHEN администратор создает новую акцию, THEN Telegram Bot SHALL сохранить Promotion с датами начала и окончания
2. WHEN администратор запускает рассылку акции, THEN Telegram Bot SHALL отправить уведомление всем активным пользователям в течение 5 минут

### Requirement 7

**User Story:** Как пользователь, я хочу видеть свою статистику и историю взаимодействия с баром, чтобы отслеживать свою активность.

#### Acceptance Criteria

1. WHEN пользователь открывает раздел профиля в Mini App, THEN Mini App SHALL отобразить баланс Loyalty Points, количество рефералов и дату регистрации
2. WHEN пользователь запрашивает историю заказов, THEN Mini App SHALL показать список всех заказов с датами и суммами
3. WHEN пользователь просматривает реферальную статистику, THEN Mini App SHALL отобразить список приглашенных пользователей и заработанные с каждого баллы

### Requirement 8

**User Story:** Как система, я должна обеспечивать безопасность и целостность данных пользователей, чтобы защитить их информацию.

#### Acceptance Criteria

1. WHEN пользователь взаимодействует с Mini App, THEN Mini App SHALL аутентифицировать пользователя через Telegram Web App API
2. WHEN происходит начисление или списание Loyalty Points, THEN Telegram Bot SHALL записать транзакцию с временной меткой и причиной изменения
3. WHEN система обрабатывает реферальное начисление, THEN Telegram Bot SHALL проверить существование связи между Referrer и Referee перед начислением баллов
4. WHEN пользователь запрашивает свои данные, THEN Telegram Bot SHALL возвращать только данные, принадлежащие этому пользователю

### Requirement 9

**User Story:** Как система, я должна корректно обрабатывать ошибки и граничные случаи, чтобы обеспечить стабильную работу.

#### Acceptance Criteria

1. WHEN пользователь пытается использовать свою собственную реферальную ссылку, THEN Telegram Bot SHALL отклонить регистрацию по этой ссылке и уведомить пользователя
2. WHEN происходит ошибка при отправке уведомления, THEN Telegram Bot SHALL записать ошибку в лог и продолжить отправку остальным пользователям
3. WHEN база данных недоступна, THEN Telegram Bot SHALL вернуть пользователю сообщение об ошибке и повторить попытку через 30 секунд
4. WHEN администратор пытается создать акцию с датой окончания раньше даты начала, THEN Telegram Bot SHALL отклонить создание и вернуть сообщение об ошибке
5. WHEN сумма заказа равна нулю или отрицательна, THEN Telegram Bot SHALL отклонить начисление баллов и записать ошибку в лог
