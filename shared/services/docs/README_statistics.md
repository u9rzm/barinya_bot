# –°–µ—Ä–≤–∏—Å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ (StatisticsService)

–°–µ—Ä–≤–∏—Å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–≤–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º, –ø—Ä–æ–≥—Ä–∞–º–º–µ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ –∏ –∑–∞–∫–∞–∑–∞–º –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏.

## –û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

### üìä –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–≤—Å–µ–≥–æ, –∞–∫—Ç–∏–≤–Ω—ã—Ö, —Å –∫–æ—à–µ–ª—å–∫–∞–º–∏, –±–µ–∑ –∫–æ—à–µ–ª—å–∫–æ–≤)
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–π (—Å–µ–≥–æ–¥–Ω—è, –∑–∞ –Ω–µ–¥–µ–ª—é, –∑–∞ –º–µ—Å—è—Ü)
- –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–≥—Ä–∞–º–º—ã –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ (–≤—ã–¥–∞–Ω–Ω—ã–µ/–ø–æ—Ç—Ä–∞—á–µ–Ω–Ω—ã–µ –±–∞–ª–ª—ã, –∞–∫—Ç–∏–≤–Ω—ã–π –±–∞–ª–∞–Ω—Å)
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–∫–∞–∑–æ–≤ (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ, –≤—ã—Ä—É—á–∫–∞, —Å—Ä–µ–¥–Ω–∏–π —á–µ–∫)

### üìà –î–µ—Ç–∞–ª—å–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞
- –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ —É—Ä–æ–≤–Ω—è–º –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏
- –¢–æ–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ –±–∞–ª–ª–∞–º –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫–æ—à–µ–ª—å–∫–æ–≤
- –¢—Ä–µ–Ω–¥—ã —Ä–æ—Å—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –ë–∞–∑–æ–≤–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

```python
from shared.database import get_async_session
from shared.services.statistics_service import StatisticsService

async def get_stats():
    async with get_async_session() as db:
        stats_service = StatisticsService(db)
        
        # –ü–æ–ª—É—á–∏—Ç—å –æ–±—â—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        overall_stats = await stats_service.get_overall_statistics()
        
        print(f"–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {overall_stats.users.total_users}")
        print(f"–ê–∫—Ç–∏–≤–Ω—ã–π –±–∞–ª–∞–Ω—Å –±–∞–ª–ª–æ–≤: {overall_stats.loyalty.active_points_balance}")
        print(f"–û–±—â–∞—è –≤—ã—Ä—É—á–∫–∞: {overall_stats.orders.total_revenue}")
```

### –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º

```python
# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
user_stats = await stats_service.get_user_statistics()

print(f"–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {user_stats.total_users}")
print(f"–ê–∫—Ç–∏–≤–Ω—ã—Ö: {user_stats.active_users}")
print(f"–° –∫–æ—à–µ–ª—å–∫–∞–º–∏: {user_stats.users_with_wallets}")
print(f"–ù–æ–≤—ã—Ö —Å–µ–≥–æ–¥–Ω—è: {user_stats.new_users_today}")
```

### –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø—Ä–æ–≥—Ä–∞–º–º—ã –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏

```python
# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏
loyalty_stats = await stats_service.get_loyalty_statistics()

print(f"–í—ã–¥–∞–Ω–æ –±–∞–ª–ª–æ–≤: {loyalty_stats.total_points_issued}")
print(f"–ü–æ—Ç—Ä–∞—á–µ–Ω–æ –±–∞–ª–ª–æ–≤: {loyalty_stats.total_points_redeemed}")
print(f"–ê–∫—Ç–∏–≤–Ω—ã–π –±–∞–ª–∞–Ω—Å: {loyalty_stats.active_points_balance}")
print(f"–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–∞–Ω—Å: {loyalty_stats.average_points_per_user}")

# –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —É—Ä–æ–≤–Ω—è–º
for level, count in loyalty_stats.users_by_level.items():
    print(f"{level}: {count} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π")
```

### –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∑–∞–∫–∞–∑–æ–≤

```python
# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–∫–∞–∑–æ–≤
order_stats = await stats_service.get_order_statistics()

print(f"–í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤: {order_stats.total_orders}")
print(f"–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö: {order_stats.completed_orders}")
print(f"–û–±—â–∞—è –≤—ã—Ä—É—á–∫–∞: {order_stats.total_revenue}")
print(f"–°—Ä–µ–¥–Ω–∏–π —á–µ–∫: {order_stats.average_order_value}")
```

### –î–µ—Ç–∞–ª—å–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞

```python
# –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —É—Ä–æ–≤–Ω—è–º –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏
level_distribution = await stats_service.get_loyalty_level_distribution()

for level_name, data in level_distribution.items():
    print(f"{level_name}:")
    print(f"  –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {data['user_count']}")
    print(f"  –°—Ä–µ–¥–Ω–∏–π –±–∞–ª–∞–Ω—Å: {data['avg_points']}")
    print(f"  –û–±—â–∞—è —Å—É–º–º–∞ —Ç—Ä–∞—Ç: {data['total_spent']}")

# –¢–æ–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
top_users = await stats_service.get_top_users_by_points(limit=10)

for i, user in enumerate(top_users, 1):
    print(f"{i}. ID: {user['telegram_id']}, –ë–∞–ª–ª—ã: {user['loyalty_points']}")

# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–æ—à–µ–ª—å–∫–æ–≤
wallet_stats = await stats_service.get_wallet_connection_stats()
print(f"–ü—Ä–æ—Ü–µ–Ω—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: {wallet_stats['connection_rate_percent']}%")

# –¢—Ä–µ–Ω–¥ —Ä–æ—Å—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
growth_trend = await stats_service.get_user_growth_trend(days=30)
for date, count in growth_trend.items():
    print(f"{date}: {count} –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π")
```

## –°—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö

### UserStatistics
```python
@dataclass
class UserStatistics:
    total_users: int                # –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    active_users: int              # –ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
    users_with_wallets: int        # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å –∫–æ—à–µ–ª—å–∫–∞–º–∏
    users_without_wallets: int     # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –±–µ–∑ –∫–æ—à–µ–ª—å–∫–æ–≤
    new_users_today: int           # –ù–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å–µ–≥–æ–¥–Ω—è
    new_users_this_week: int       # –ù–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∑–∞ –Ω–µ–¥–µ–ª—é
    new_users_this_month: int      # –ù–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∑–∞ –º–µ—Å—è—Ü
```

### LoyaltyStatistics
```python
@dataclass
class LoyaltyStatistics:
    total_points_issued: float          # –í—Å–µ–≥–æ –≤—ã–¥–∞–Ω–æ –±–∞–ª–ª–æ–≤
    total_points_redeemed: float        # –í—Å–µ–≥–æ –ø–æ—Ç—Ä–∞—á–µ–Ω–æ –±–∞–ª–ª–æ–≤
    active_points_balance: float        # –ê–∫—Ç–∏–≤–Ω—ã–π –±–∞–ª–∞–Ω—Å –±–∞–ª–ª–æ–≤
    users_by_level: Dict[str, int]      # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ —É—Ä–æ–≤–Ω—è–º
    average_points_per_user: float      # –°—Ä–µ–¥–Ω–∏–π –±–∞–ª–∞–Ω—Å –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    points_transactions_today: int      # –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–π —Å–µ–≥–æ–¥–Ω—è
    points_transactions_this_week: int  # –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –∑–∞ –Ω–µ–¥–µ–ª—é
    points_transactions_this_month: int # –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –∑–∞ –º–µ—Å—è—Ü
```

### OrderStatistics
```python
@dataclass
class OrderStatistics:
    total_orders: int           # –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–∫–∞–∑–æ–≤
    completed_orders: int       # –ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã
    pending_orders: int         # –ó–∞–∫–∞–∑—ã –≤ –æ–∂–∏–¥–∞–Ω–∏–∏
    cancelled_orders: int       # –û—Ç–º–µ–Ω–µ–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã
    total_revenue: float        # –û–±—â–∞—è –≤—ã—Ä—É—á–∫–∞
    average_order_value: float  # –°—Ä–µ–¥–Ω–∏–π —á–µ–∫
    orders_today: int           # –ó–∞–∫–∞–∑–æ–≤ —Å–µ–≥–æ–¥–Ω—è
    orders_this_week: int       # –ó–∞–∫–∞–∑–æ–≤ –∑–∞ –Ω–µ–¥–µ–ª—é
    orders_this_month: int      # –ó–∞–∫–∞–∑–æ–≤ –∑–∞ –º–µ—Å—è—Ü
```

### OverallStatistics
```python
@dataclass
class OverallStatistics:
    users: UserStatistics       # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    loyalty: LoyaltyStatistics   # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏
    orders: OrderStatistics      # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–∫–∞–∑–æ–≤
    generated_at: datetime       # –í—Ä–µ–º—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
```

## –ú–µ—Ç–æ–¥—ã —Å–µ—Ä–≤–∏—Å–∞

### –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã
- `get_user_statistics()` - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- `get_loyalty_statistics()` - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–≥—Ä–∞–º–º—ã –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏
- `get_order_statistics()` - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–∫–∞–∑–æ–≤
- `get_overall_statistics()` - –æ–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

### –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã
- `get_user_growth_trend(days=30)` - —Ç—Ä–µ–Ω–¥ —Ä–æ—Å—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- `get_loyalty_level_distribution()` - —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —É—Ä–æ–≤–Ω—è–º –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏
- `get_top_users_by_points(limit=10)` - —Ç–æ–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ –±–∞–ª–ª–∞–º
- `get_wallet_connection_stats()` - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫–æ—à–µ–ª—å–∫–æ–≤

## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –∞–¥–º–∏–Ω—Å–∫–æ–π –ø–∞–Ω–µ–ª—å—é

–°–µ—Ä–≤–∏—Å –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω –≤ –∞–¥–º–∏–Ω—Å–∫—É—é –ø–∞–Ω–µ–ª—å –±–æ—Ç–∞ —á–µ—Ä–µ–∑ –∫–æ–º–∞–Ω–¥—ã:
- `/settings` ‚Üí `üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞` - –æ—Å–Ω–æ–≤–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
- `üìà –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞` - —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —É—Ä–æ–≤–Ω—è–º –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏
- `üèÜ –¢–æ–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π` - —Ç–æ–ø-10 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ –±–∞–ª–ª–∞–º
- `üí≥ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–æ—à–µ–ª—å–∫–æ–≤` - –º–µ—Ç—Ä–∏–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫–æ—à–µ–ª—å–∫–æ–≤

## –ü—Ä–∏–º–µ—Ä –∑–∞–ø—É—Å–∫–∞

–î–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ —Ä–∞–±–æ—Ç—ã —Å–µ—Ä–≤–∏—Å–∞ –∑–∞–ø—É—Å—Ç–∏—Ç–µ:

```bash
python scripts/statistics_example.py
```

–≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –ø–æ–∫–∞–∂–µ—Ç –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏.

## –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

–°–µ—Ä–≤–∏—Å –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –±–æ–ª—å—à–∏–º–∏ –æ–±—ä–µ–º–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö:
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –∞–≥—Ä–µ–≥–∏—Ä—É—é—â–∏–µ SQL-–∑–∞–ø—Ä–æ—Å—ã
- –ú–∏–Ω–∏–º–∏–∑–∏—Ä—É–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±—Ä–∞—â–µ–Ω–∏–π –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
- –ö—ç—à–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –Ω–∞ —É—Ä–æ–≤–Ω–µ —Å–µ—Å—Å–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

## –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏

–î–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤—ã—Ö –º–µ—Ç—Ä–∏–∫:

1. –î–æ–±–∞–≤—å—Ç–µ –Ω–æ–≤—ã–π –º–µ—Ç–æ–¥ –≤ –∫–ª–∞—Å—Å `StatisticsService`
2. –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π dataclass –¥–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö
3. –û–±–Ω–æ–≤–∏—Ç–µ `__init__.py` –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –Ω–æ–≤—ã—Ö –∫–ª–∞—Å—Å–æ–≤
4. –î–æ–±–∞–≤—å—Ç–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤ –∞–¥–º–∏–Ω—Å–∫—É—é –ø–∞–Ω–µ–ª—å