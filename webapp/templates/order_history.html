{% extends "layout.html" %}

{% block title %}История заказов - Bar Bot{% endblock %}

{% block content %}
<div class="p-4">
    <!-- Header -->
    <div class="mb-6">
        <h1 class="text-2xl font-bold text-tg-text mb-2">История заказов</h1>
        <p class="text-tg-hint">Все ваши заказы в баре</p>
    </div>

    <!-- Loading State -->
    <div id="loading-orders" class="flex justify-center items-center py-8">
        <div class="spinner"></div>
        <span class="ml-2 text-tg-hint">Загрузка заказов...</span>
    </div>

    <!-- Orders Content -->
    <div id="orders-content" class="hidden">
        <!-- Summary Stats -->
        <div class="stats-grid mb-6">
            <div class="stat-card">
                <div class="stat-value" id="total-orders">0</div>
                <div class="stat-label">Всего заказов</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="total-amount">0 ₽</div>
                <div class="stat-label">Общая сумма</div>
            </div>
        </div>

        <!-- Orders List -->
        <div id="orders-list" class="space-y-4">
            <!-- Orders will be populated here -->
        </div>

        <!-- Load More Button -->
        <div id="load-more-container" class="hidden text-center mt-6">
            <button id="load-more-btn" class="btn-secondary" onclick="loadMoreOrders()">
                Загрузить еще
            </button>
        </div>
    </div>

    <!-- Empty State -->
    <div id="empty-orders" class="hidden text-center py-12">
        <svg class="w-16 h-16 text-tg-hint mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
        </svg>
        <h3 class="text-lg font-medium text-tg-text mb-2">Заказов пока нет</h3>
        <p class="text-tg-hint mb-4">Сделайте первый заказ в нашем баре</p>
        <a href="/menu" class="btn-primary">Посмотреть меню</a>
    </div>

    <!-- Error State -->
    <div id="error-orders" class="hidden text-center py-12">
        <svg class="w-16 h-16 text-red-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <h3 class="text-lg font-medium text-tg-text mb-2">Ошибка загрузки</h3>
        <p class="text-tg-hint mb-4">Не удалось загрузить историю заказов</p>
        <button class="btn-primary" onclick="loadOrders()">Попробовать снова</button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Order history page functionality
let ordersData = [];
let currentPage = 1;
let hasMoreOrders = true;
const ordersPerPage = 10;

document.addEventListener('DOMContentLoaded', function() {
    loadOrders();
});

/**
 * Load orders from API
 */
async function loadOrders(page = 1) {
    try {
        if (page === 1) {
            BarBot.showLoading();
            ordersData = [];
        }
        
        const response = await BarBot.apiRequest(`/order/history?page=${page}&limit=${ordersPerPage}`);
        
        if (page === 1) {
            ordersData = response.orders;
        } else {
            ordersData = [...ordersData, ...response.orders];
        }
        
        hasMoreOrders = response.has_more;
        currentPage = page;
        
        displayOrders();
        
    } catch (error) {
        console.error('Error loading orders:', error);
        showErrorState();
    } finally {
        if (page === 1) {
            BarBot.hideLoading();
        }
    }
}

/**
 * Load more orders
 */
async function loadMoreOrders() {
    const loadMoreBtn = document.getElementById('load-more-btn');
    loadMoreBtn.disabled = true;
    loadMoreBtn.textContent = 'Загрузка...';
    
    try {
        await loadOrders(currentPage + 1);
    } finally {
        loadMoreBtn.disabled = false;
        loadMoreBtn.textContent = 'Загрузить еще';
    }
}

/**
 * Display orders data
 */
function displayOrders() {
    if (ordersData.length === 0) {
        showEmptyState();
        return;
    }
    
    // Update summary stats
    const totalOrders = ordersData.length;
    const totalAmount = ordersData.reduce((sum, order) => sum + order.total_amount, 0);
    
    document.getElementById('total-orders').textContent = totalOrders;
    document.getElementById('total-amount').textContent = BarBot.formatCurrency(totalAmount);
    
    // Render orders list
    const ordersList = document.getElementById('orders-list');
    ordersList.innerHTML = '';
    
    ordersData.forEach(order => {
        const orderElement = createOrderElement(order);
        ordersList.appendChild(orderElement);
    });
    
    // Show/hide load more button
    const loadMoreContainer = document.getElementById('load-more-container');
    if (hasMoreOrders) {
        loadMoreContainer.classList.remove('hidden');
    } else {
        loadMoreContainer.classList.add('hidden');
    }
    
    // Show content
    document.getElementById('loading-orders').classList.add('hidden');
    document.getElementById('orders-content').classList.remove('hidden');
}

/**
 * Create order element
 */
function createOrderElement(order) {
    const orderDiv = document.createElement('div');
    orderDiv.className = 'card cursor-pointer hover:bg-opacity-80 transition-colors';
    orderDiv.onclick = () => showOrderDetails(order);
    
    const statusColor = getStatusColor(order.status);
    const statusText = getStatusText(order.status);
    
    orderDiv.innerHTML = `
        <div class="flex items-center justify-between mb-3">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-tg-button rounded-full flex items-center justify-center">
                    <svg class="w-5 h-5 text-tg-button-text" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
                    </svg>
                </div>
                <div>
                    <h3 class="font-medium text-tg-text">Заказ #${order.id}</h3>
                    <p class="text-sm text-tg-hint">${BarBot.formatDate(order.created_at)}</p>
                </div>
            </div>
            <div class="text-right">
                <div class="font-semibold text-tg-text">${BarBot.formatCurrency(order.total_amount)}</div>
                <div class="text-sm ${statusColor}">${statusText}</div>
            </div>
        </div>
        
        ${order.items && order.items.length > 0 ? `
        <div class="border-t border-tg-secondary-bg pt-3">
            <div class="text-sm text-tg-hint mb-2">Позиции заказа:</div>
            <div class="space-y-1">
                ${order.items.slice(0, 3).map(item => `
                    <div class="flex justify-between text-sm">
                        <span class="text-tg-text">${item.menu_item?.name || 'Позиция'} x${item.quantity}</span>
                        <span class="text-tg-hint">${BarBot.formatCurrency(item.price * item.quantity)}</span>
                    </div>
                `).join('')}
                ${order.items.length > 3 ? `
                    <div class="text-xs text-tg-hint">и еще ${order.items.length - 3} позиций...</div>
                ` : ''}
            </div>
        </div>
        ` : ''}
        
        <div class="flex items-center justify-end mt-3 pt-3 border-t border-tg-secondary-bg">
            <svg class="w-4 h-4 text-tg-hint" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
        </div>
    `;
    
    return orderDiv;
}

/**
 * Get status color class
 */
function getStatusColor(status) {
    switch (status) {
        case 'COMPLETED':
            return 'text-green-500';
        case 'PENDING':
            return 'text-yellow-500';
        case 'CANCELLED':
            return 'text-red-500';
        default:
            return 'text-tg-hint';
    }
}

/**
 * Get status text
 */
function getStatusText(status) {
    switch (status) {
        case 'COMPLETED':
            return 'Выполнен';
        case 'PENDING':
            return 'В обработке';
        case 'CANCELLED':
            return 'Отменен';
        default:
            return 'Неизвестно';
    }
}

/**
 * Show order details modal
 */
function showOrderDetails(order) {
    const itemsList = order.items ? order.items.map(item => 
        `${item.menu_item?.name || 'Позиция'} x${item.quantity} - ${BarBot.formatCurrency(item.price * item.quantity)}`
    ).join('\n') : 'Нет данных о позициях';
    
    const details = `
Заказ #${order.id}
Дата: ${BarBot.formatDate(order.created_at)}
Статус: ${getStatusText(order.status)}

Позиции:
${itemsList}

Итого: ${BarBot.formatCurrency(order.total_amount)}
    `.trim();
    
    BarBot.showSuccess(details);
}

/**
 * Show empty state
 */
function showEmptyState() {
    document.getElementById('loading-orders').classList.add('hidden');
    document.getElementById('orders-content').classList.add('hidden');
    document.getElementById('empty-orders').classList.remove('hidden');
}

/**
 * Show error state
 */
function showErrorState() {
    document.getElementById('loading-orders').classList.add('hidden');
    document.getElementById('orders-content').classList.add('hidden');
    document.getElementById('error-orders').classList.remove('hidden');
}
</script>
{% endblock %}