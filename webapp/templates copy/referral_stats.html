{% extends "layout.html" %}

{% block title %}–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ - Bar Bot{% endblock %}

{% block content %}
<div class="p-4">
    <!-- Header -->
    <div class="mb-6">
        <div class="flex items-center space-x-3 mb-2">
            <a href="/profile" class="text-tg-button">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
            </a>
            <h1 class="text-2xl font-bold text-tg-text">–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞</h1>
        </div>
        <p class="text-tg-hint">–ü—Ä–∏–≥–ª–∞—à–∞–π—Ç–µ –¥—Ä—É–∑–µ–π –∏ –ø–æ–ª—É—á–∞–π—Ç–µ 1% —Å –∏—Ö –∑–∞–∫–∞–∑–æ–≤</p>
    </div>

    <!-- Loading State -->
    <div id="loading-referrals" class="flex justify-center items-center py-8">
        <div class="spinner"></div>
        <span class="ml-2 text-tg-hint">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</span>
    </div>

    <!-- Referral Content -->
    <div id="referral-content" class="hidden space-y-6">
        <!-- Stats Overview -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="total-referrals">0</div>
                <div class="stat-label">–ü—Ä–∏–≥–ª–∞—à–µ–Ω–æ –¥—Ä—É–∑–µ–π</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="total-earned">0</div>
                <div class="stat-label">–ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ –±–∞–ª–ª–æ–≤</div>
            </div>
        </div>

        <!-- Referral Link -->
        <div class="card">
            <h3 class="text-lg font-semibold text-tg-text mb-4">–í–∞—à–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞</h3>
            
            <div class="bg-tg-bg border border-tg-secondary-bg rounded-lg p-3 mb-4">
                <div class="flex items-center justify-between">
                    <span id="referral-link" class="text-sm text-tg-text font-mono truncate flex-1 mr-3">
                        –ó–∞–≥—Ä—É–∑–∫–∞...
                    </span>
                    <button id="copy-link-btn" class="btn-secondary text-sm px-3 py-1" onclick="copyReferralLink()">
                        –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
                    </button>
                </div>
            </div>
            
            <div class="flex space-x-2">
                <button class="btn-primary flex-1" onclick="shareReferralLink()">
                    <svg class="w-4 h-4 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z"></path>
                    </svg>
                    –ü–æ–¥–µ–ª–∏—Ç—å—Å—è
                </button>
                <button class="btn-secondary" onclick="generateQRCode()">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"></path>
                    </svg>
                </button>
            </div>
            
            <div class="mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                <div class="flex items-start space-x-2">
                    <svg class="w-5 h-5 text-blue-500 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <div class="text-sm text-blue-700">
                        <p class="font-medium mb-1">–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:</p>
                        <ul class="space-y-1 text-xs">
                            <li>‚Ä¢ –ü–æ–¥–µ–ª–∏—Ç–µ—Å—å —Å—Å—ã–ª–∫–æ–π —Å –¥—Ä—É–∑—å—è–º–∏</li>
                            <li>‚Ä¢ –û–Ω–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É—é—Ç—Å—è —á–µ—Ä–µ–∑ –≤–∞—à—É —Å—Å—ã–ª–∫—É</li>
                            <li>‚Ä¢ –í—ã –ø–æ–ª—É—á–∞–µ—Ç–µ 1% —Å –∫–∞–∂–¥–æ–≥–æ –∏—Ö –∑–∞–∫–∞–∑–∞</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Referrals List -->
        <div class="card">
            <h3 class="text-lg font-semibold text-tg-text mb-4">–ü—Ä–∏–≥–ª–∞—à–µ–Ω–Ω—ã–µ –¥—Ä—É–∑—å—è</h3>
            
            <div id="referrals-list" class="space-y-3">
                <!-- Referrals will be loaded here -->
            </div>
            
            <div id="no-referrals" class="hidden text-center py-8">
                <svg class="w-16 h-16 mx-auto text-tg-hint mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                </svg>
                <p class="text-tg-hint text-lg mb-2">–ü–æ–∫–∞ –Ω–∏–∫–æ–≥–æ –Ω–µ –ø—Ä–∏–≥–ª–∞—Å–∏–ª–∏</p>
                <p class="text-tg-hint text-sm">–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å —Å—Å—ã–ª–∫–æ–π —Å –¥—Ä—É–∑—å—è–º–∏ –∏ –Ω–∞—á–Ω–∏—Ç–µ –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –±–∞–ª–ª—ã!</p>
            </div>
        </div>
    </div>

    <!-- Error State -->
    <div id="error-referrals" class="hidden text-center py-8">
        <svg class="w-16 h-16 mx-auto text-red-500 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <p class="text-red-600 text-lg mb-2">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p>
        <p class="text-tg-hint text-sm mb-4">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ —Ä–µ—Ñ–µ—Ä–∞–ª–∞—Ö</p>
        <button class="btn-primary" onclick="loadReferralData()">–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</button>
    </div>
</div>

<script>
// Referral stats page functionality
let referralData = null;

document.addEventListener('DOMContentLoaded', function() {
    loadReferralData();
});

/**
 * Load referral data from API
 */
async function loadReferralData() {
    try {
        showLoadingState();
        
        // Load referral link and stats in parallel
        const [linkResponse, statsResponse] = await Promise.all([
            BarBot.apiRequest('/referral/link'),
            BarBot.apiRequest('/referral/stats')
        ]);
        
        referralData = {
            link: linkResponse,
            stats: statsResponse
        };
        
        displayReferralData();
        hideLoadingState();
        
    } catch (error) {
        console.error('Error loading referral data:', error);
        showErrorState();
    }
}

/**
 * Display referral data in the UI
 */
function displayReferralData() {
    if (!referralData) return;
    
    const { link, stats } = referralData;
    
    // Update stats overview
    document.getElementById('total-referrals').textContent = stats.total_referrals;
    document.getElementById('total-earned').textContent = BarBot.formatPoints(stats.total_earned);
    
    // Update referral link
    document.getElementById('referral-link').textContent = link.referral_link;
    
    // Display referrals list
    displayReferralsList(stats.referrals);
}

/**
 * Display list of referrals
 */
function displayReferralsList(referrals) {
    const listContainer = document.getElementById('referrals-list');
    const noReferralsContainer = document.getElementById('no-referrals');
    
    if (!referrals || referrals.length === 0) {
        listContainer.innerHTML = '';
        noReferralsContainer.classList.remove('hidden');
        return;
    }
    
    noReferralsContainer.classList.add('hidden');
    
    const referralsHtml = referrals.map(referral => {
        const user = referral.user;
        const displayName = user.first_name || user.username || `User ${user.telegram_id}`;
        const joinDate = BarBot.formatDate(user.created_at);
        const earnedPoints = BarBot.formatPoints(referral.earned_from_user);
        
        return `
            <div class="flex items-center justify-between p-3 bg-tg-secondary-bg rounded-lg">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-tg-button rounded-full flex items-center justify-center">
                        <span class="text-tg-button-text font-semibold text-sm">
                            ${displayName.charAt(0).toUpperCase()}
                        </span>
                    </div>
                    <div>
                        <p class="font-medium text-tg-text">${displayName}</p>
                        <p class="text-sm text-tg-hint">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è ${joinDate}</p>
                    </div>
                </div>
                <div class="text-right">
                    <p class="font-semibold text-tg-text">${earnedPoints}</p>
                    <p class="text-xs text-tg-hint">–±–∞–ª–ª–æ–≤</p>
                </div>
            </div>
        `;
    }).join('');
    
    listContainer.innerHTML = referralsHtml;
}

/**
 * Copy referral link to clipboard
 */
async function copyReferralLink() {
    if (!referralData?.link?.referral_link) {
        BarBot.showError('–°—Å—ã–ª–∫–∞ –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
        return;
    }
    
    try {
        await BarBot.copyToClipboard(referralData.link.referral_link);
        
        // Update button text temporarily
        const button = document.getElementById('copy-link-btn');
        const originalText = button.textContent;
        button.textContent = '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
        button.classList.add('bg-green-500', 'text-white');
        
        setTimeout(() => {
            button.textContent = originalText;
            button.classList.remove('bg-green-500', 'text-white');
        }, 2000);
        
    } catch (error) {
        console.error('Error copying link:', error);
        BarBot.showError('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É');
    }
}

/**
 * Share referral link using Telegram Web App
 */
function shareReferralLink() {
    if (!referralData?.link?.referral_link) {
        BarBot.showError('–°—Å—ã–ª–∫–∞ –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
        return;
    }
    
    const message = `üéâ –ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Å—è –∫ –Ω–∞—à–µ–º—É –±–∞—Ä—É!\n\n` +
                   `–†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Å—è –ø–æ –º–æ–µ–π —Å—Å—ã–ª–∫–µ –∏ –ø–æ–ª—É—á–∞–π –±–∞–ª–ª—ã –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ –∑–∞ –∫–∞–∂–¥—ã–π –∑–∞–∫–∞–∑!\n\n` +
                   `${referralData.link.referral_link}`;
    
    // Use Telegram Web App share functionality
    if (window.Telegram?.WebApp?.openTelegramLink) {
        const shareUrl = `https://t.me/share/url?url=${encodeURIComponent(referralData.link.referral_link)}&text=${encodeURIComponent(message)}`;
        window.Telegram.WebApp.openTelegramLink(shareUrl);
    } else {
        // Fallback: copy to clipboard
        copyReferralLink();
    }
}

/**
 * Generate QR code for referral link
 */
function generateQRCode() {
    if (!referralData?.link?.referral_link) {
        BarBot.showError('–°—Å—ã–ª–∫–∞ –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
        return;
    }
    
    // For now, just copy the link - QR code generation can be added later
    copyReferralLink();
    BarBot.showSuccess('QR –∫–æ–¥ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –≤ —Å–ª–µ–¥—É—é—â–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏');
}

/**
 * Show loading state
 */
function showLoadingState() {
    document.getElementById('loading-referrals').classList.remove('hidden');
    document.getElementById('referral-content').classList.add('hidden');
    document.getElementById('error-referrals').classList.add('hidden');
}

/**
 * Hide loading state and show content
 */
function hideLoadingState() {
    document.getElementById('loading-referrals').classList.add('hidden');
    document.getElementById('referral-content').classList.remove('hidden');
    document.getElementById('error-referrals').classList.add('hidden');
}

/**
 * Show error state
 */
function showErrorState() {
    document.getElementById('loading-referrals').classList.add('hidden');
    document.getElementById('referral-content').classList.add('hidden');
    document.getElementById('error-referrals').classList.remove('hidden');
}
</script>

{% endblock %}